<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Blockly Lesson 6 - Logic</title>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
    body { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); display: flex; flex-direction: column; }

    .top-bar {
      background: rgba(255, 255, 255, 0.95);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 100;
    }
    
    .lesson-title {
      font-size: 1.5em;
      font-weight: bold;
      color: #a18cd1;
    }
    
    .progress-bar {
      flex: 1;
      max-width: 300px;
      height: 30px;
      background: #e0e0e0;
      border-radius: 15px;
      margin: 0 20px;
      overflow: hidden;
      position: relative;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #a18cd1, #fbc2eb);
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    .stars {
      font-size: 1.5em;
    }

    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
      position: relative;
    }
    
    #blocklyDiv {
      flex: 1;
      height: 100%;
    }

    .challenge-overlay {
      position: absolute;
      top: 20px;
      right: 20px;
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      max-width: 350px;
      z-index: 50;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .challenge-header {
      background: linear-gradient(135deg, #a18cd1, #fbc2eb);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .challenge-number {
      font-size: 0.9em;
      opacity: 0.9;
      margin-bottom: 5px;
    }
    
    .challenge-title {
      font-size: 1.3em;
      font-weight: bold;
    }
    
    .challenge-description {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      border-left: 4px solid #a18cd1;
      line-height: 1.6;
    }
    
    .expected-output {
      background: #e3f2fd;
      padding: 10px 15px;
      border-radius: 8px;
      font-weight: bold;
      text-align: center;
      color: #1976d2;
      margin-bottom: 15px;
      font-size: 1.1em;
      white-space: pre-line;
    }

    .bottom-controls {
      background: white;
      padding: 15px 20px;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      flex-wrap: wrap;
    }
    
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    button:active { transform: translateY(0); }
    
    .btn-primary { background: #a18cd1; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-nav { background: #f8f9fa; color: #333; border: 2px solid #ddd; }
    .btn-nav:disabled { opacity: 0.5; cursor: not-allowed; }

    .feedback {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      text-align: center;
      z-index: 1000;
      min-width: 300px;
      animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
    }
    
    @keyframes popIn {
      to { transform: translate(-50%, -50%) scale(1); }
    }
    
    .feedback-icon {
      font-size: 4em;
      margin-bottom: 15px;
    }
    
    .feedback-message {
      font-size: 1.3em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .feedback.success { border-top: 5px solid #28a745; }
    .feedback.error { border-top: 5px solid #dc3545; }
    
    .backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: none;
    }
    
    .backdrop.active { display: block; }

    .hint-box {
      background: #fff3cd;
      border: 2px solid #ffc107;
      color: #856404;
      padding: 15px;
      border-radius: 10px;
      margin-top: 10px;
      display: none;
      animation: slideDown 0.3s ease-out;
    }
    
    .hint-box.show { display: block; }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 768px) {
      .challenge-overlay { right: 10px; top: 10px; max-width: 300px; padding: 15px; }
      .top-bar { flex-wrap: wrap; padding: 10px; }
      .lesson-title { font-size: 1.2em; }
      button { padding: 10px 18px; font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="lesson-title">ü§î Logic & Conditionals</div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressBar">0%</div>
    </div>
    <div class="stars" id="starsDisplay">‚≠ê‚≠ê‚≠ê‚≠ê</div>
  </div>

  <div class="main-content">
    <div id="blocklyDiv"></div>
    
    <div class="challenge-overlay">
      <div class="challenge-header">
        <div class="challenge-number" id="challengeNumber">Challenge 1 of 4</div>
        <div class="challenge-title" id="challengeTitle">Greater Than</div>
      </div>
      <div class="challenge-description" id="challengeDescription">
        If 10 is greater than 5, print "Yes"
      </div>
      <div class="expected-output" id="expectedOutput">Expected: Yes</div>
      <div class="hint-box" id="hintBox"></div>
    </div>
  </div>

  <div class="bottom-controls">
    <button class="btn-nav" id="prevBtn" onclick="previousChallenge()" disabled>‚óÄ Previous</button>
    <button class="btn-secondary" onclick="resetWorkspace()">üîÑ Reset</button>
    <button class="btn-secondary" onclick="showHint()">üí° Hint</button>
    <button class="btn-primary" onclick="runCode()">‚ñ∂ Run Code</button>
    <button class="btn-success" onclick="checkSolution()">‚úì Check Answer</button>
    <button class="btn-nav" id="nextBtn" onclick="nextChallenge()">Next ‚ñ∂</button>
  </div>

  <div class="backdrop" id="backdrop"></div>

  <script>
    const workspace = Blockly.inject('blocklyDiv', {
      toolbox: `
        <xml xmlns="https://developers.google.com/blockly/xml">
          <category name="ü§î Logic" colour="210">
            <block type="controls_if"></block>
            <block type="controls_ifelse"></block>
            <block type="logic_compare">
              <field name="OP">GT</field>
            </block>
            <block type="logic_operation">
              <field name="OP">AND</field>
            </block>
            <block type="logic_boolean"></block>
          </category>
          <category name="üìù Print" colour="160">
            <block type="text_print">
              <value name="TEXT">
                <shadow type="text"><field name="TEXT">Hello</field></shadow>
              </value>
            </block>
          </category>
          <category name="üî§ Text" colour="160">
            <block type="text"><field name="TEXT">Hello</field></block>
          </category>
          <category name="üî¢ Numbers" colour="230">
            <block type="math_number"><field name="NUM">1</field></block>
          </category>
        </xml>
      `,
      zoom: { controls: true, wheel: true, startScale: 1.0, maxScale: 3, minScale: 0.3, scaleSpeed: 1.2 },
      trashcan: true,
      grid: { spacing: 20, length: 3, colour: '#ccc', snap: true }
    });

    let currentChallenge = 0;
    let completedChallenges = [false, false, false, false];

    const challenges = [
      {
        title: "Greater Than",
        description: 'If 10 is greater than 5, print "Yes"',
        expected: "Yes",
        hint: 'Use an "if" block from Logic. Add a comparison block (>) with 10 and 5. Inside, print "Yes"',
        validate: (output) => output.trim().toLowerCase() === 'yes'
      },
      {
        title: "Equal Check",
        description: 'If 7 equals 7, print "Equal", otherwise print "Not Equal"',
        expected: "Equal",
        hint: 'Use an "if/else" block. Check if 7 = 7 (use = comparison). Print "Equal" in if part.',
        validate: (output) => output.trim().toLowerCase() === 'equal'
      },
      {
        title: "Greater or Less",
        description: 'If 3 is less than 8, print "Smaller", otherwise print "Bigger"',
        expected: "Smaller",
        hint: 'Use "if/else" block. Check if 3 < 8. Print "Smaller" in if section.',
        validate: (output) => output.trim().toLowerCase() === 'smaller'
      },
      {
        title: "Age Check",
        description: 'If 15 is greater than or equal to 10, print "Old enough", otherwise print "Too young"',
        expected: "Old enough",
        hint: 'Use "if/else" with ‚â• comparison. Check if 15 ‚â• 10. Print "Old enough" in the if part.',
        validate: (output) => output.trim().toLowerCase() === 'old enough'
      }
    ];

    function updateUI() {
      const challenge = challenges[currentChallenge];
      document.getElementById('challengeNumber').textContent = `Challenge ${currentChallenge + 1} of 4`;
      document.getElementById('challengeTitle').textContent = challenge.title;
      document.getElementById('challengeDescription').textContent = challenge.description;
      document.getElementById('expectedOutput').textContent = 'Expected: ' + challenge.expected;
      document.getElementById('prevBtn').disabled = currentChallenge === 0;
      document.getElementById('nextBtn').disabled = currentChallenge === challenges.length - 1;
      updateProgress();
      document.getElementById('hintBox').classList.remove('show');
    }

    function updateProgress() {
      const completed = completedChallenges.filter(c => c).length;
      const percent = Math.round((completed / challenges.length) * 100);
      const progressBar = document.getElementById('progressBar');
      progressBar.style.width = percent + '%';
      progressBar.textContent = percent + '%';
      
      const stars = ['‚≠ê', '‚≠ê', '‚≠ê', '‚≠ê'].map((s, i) => i < completed ? '‚≠ê' : '‚òÜ').join('');
      document.getElementById('starsDisplay').textContent = stars;
    }

    function runCode() {
      let output = [];
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
      let code = Blockly.JavaScript.workspaceToCode(workspace);
      
      if (!code.trim()) {
        showFeedback('‚ö†Ô∏è', 'Your workspace is empty!', 'Add some blocks first.', 'error');
        return;
      }

      const originalAlert = window.alert;
      window.alert = function(msg) { output.push(String(msg)); };

      try {
        eval(code);
        if (output.length === 0) {
          showFeedback('‚ö†Ô∏è', 'No output!', 'Did you use a print block?', 'error');
        } else {
          showFeedback('‚úÖ', 'Code Ran!', output.join('\n'), 'success');
        }
      } catch (e) {
        showFeedback('‚ùå', 'Error!', e.message, 'error');
      } finally {
        window.alert = originalAlert;
      }
    }

    function checkSolution() {
      let output = [];
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
      let code = Blockly.JavaScript.workspaceToCode(workspace);
      
      if (!code.trim()) {
        showFeedback('‚ö†Ô∏è', 'Empty Workspace!', 'Add some blocks first.', 'error');
        return;
      }

      const originalAlert = window.alert;
      window.alert = function(msg) { output.push(String(msg)); };

      try {
        eval(code);
        const result = output.length > 0 ? output[0] : '';
        
        if (challenges[currentChallenge].validate(result)) {
          completedChallenges[currentChallenge] = true;
          updateProgress();
          
          if (currentChallenge < challenges.length - 1) {
            showFeedback('üéâ', 'Correct!', 'Great job! Moving to next challenge...', 'success');
            setTimeout(() => {
              hideAllFeedback();
              currentChallenge++;
              updateUI();
            }, 2000);
          } else {
            showFeedback('üèÜ', 'Lesson Complete!', `You earned ${completedChallenges.filter(c=>c).length} stars! Amazing work!`, 'success');
            
            if (window.parent && window.parent !== window) {
              window.parent.postMessage({
                type: 'html-game-complete',
                game: 'blockly-lesson-6'
              }, '*');
            }
          }
        } else {
          showFeedback('‚ùå', 'Not Quite Right', 'Check the expected output and try again!', 'error');
        }
      } catch (e) {
        showFeedback('‚ùå', 'Error!', e.message, 'error');
      } finally {
        window.alert = originalAlert;
      }
    }

    function showHint() {
      const hintBox = document.getElementById('hintBox');
      hintBox.textContent = 'üí° ' + challenges[currentChallenge].hint;
      hintBox.classList.add('show');
      setTimeout(() => hintBox.classList.remove('show'), 8000);
    }

    function nextChallenge() {
      if (currentChallenge < challenges.length - 1) {
        currentChallenge++;
        updateUI();
      }
    }

    function previousChallenge() {
      if (currentChallenge > 0) {
        currentChallenge--;
        updateUI();
      }
    }

    function resetWorkspace() {
      if (confirm('Clear your workspace?')) {
        workspace.clear();
        showFeedback('üîÑ', 'Workspace Cleared', 'Start fresh!', 'success');
      }
    }

    function showFeedback(icon, title, message, type) {
      hideAllFeedback();
      const feedback = document.createElement('div');
      feedback.className = `feedback ${type}`;
      feedback.innerHTML = `
        <div class="feedback-icon">${icon}</div>
        <div class="feedback-message">${title}</div>
        <div>${message}</div>
      `;
      document.body.appendChild(feedback);
      document.getElementById('backdrop').classList.add('active');
      
      setTimeout(hideAllFeedback, 3000);
    }

    function hideAllFeedback() {
      document.querySelectorAll('.feedback').forEach(f => f.remove());
      document.getElementById('backdrop').classList.remove('active');
    }

    document.getElementById('backdrop').addEventListener('click', hideAllFeedback);
    updateUI();
  </script>
</body>
</html>
